rules:
  use-problem-json-for-errors:
    description: >-
      Error responses should support [RFC 7807](https://tools.ietf.org/html/rfc6648) 
    message: >-
      Error responses should support [RFC 7807](https://tools.ietf.org/html/rfc6648) in {{path}}.
    formats:
      - oas3
    severity: error
    given: >-
      $.paths.[*].responses[?(@property.match(/^(4|5|default)/))].content.*~
    then:
      function: enumeration
      functionOptions:
        values:
        - application/problem+xml
        - application/problem+json  

  use-problem-schema:
    description: >-
      APIs should use Problem json for errors.
      See https://docs.italia.it/italia/piano-triennale-ict/lg-modellointeroperabilita-docs/it/bozza/doc/profili-di-interazione/regole-comuni-rest-soap.html#usare-lo-schema-problem-json-per-le-risposte-di-errore
    message: >-
      Use RFC7807 schema to model errors, not "{{value}}". {{path}}
    formats:
    - oas3
    severity: error
    recommended: true
    # Search for 4xx, 5xx and default responses schema.
    given: >-
      $.paths.[*].responses[?(@property.match(/^(4|5|default)/))][[schema]]
    then:
      function: schema
      functionOptions:
        schema:
          $ref: https://teamdigitale.github.io/openapi/0.0.6/definitions.yaml#/schemas/Problem


