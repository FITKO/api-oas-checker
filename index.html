<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>Browserify hello world</title>
<style>
.line-error {
	background: #fbc2c4 !important;
}

.linter {
    float: right;
    width: 39%;
    border: solid 1px;
    background-color: yellow;
}

.editor-div {
	background-color: lightgreen;
	width: 60%; 
	border: solid 1px; 
	float: left;
}

</style>
<script src="out.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.51.0/codemirror.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.51.0/codemirror.min.css">

<script>
testUrl = "https://raw.githubusercontent.com/teamdigitale/anpr-dashboard-server/master/openapi/anpr-dashboard.yaml";

function parse_url(){
	url = document.getElementById('oas_url').value;
    if (url == "") {
    	url = testUrl
    	document.getElementById('oas_url').value = testUrl
    }
    lint_url(url);
}

async function parse_text(){
	oas_text = editor.getValue();
    // console.log("oas_text:" + oas_text);
    await lint_spec(oas_text);
}

async function lint_spec(oas) {
	const lint = await browserify_hello_world.parse(oas);
	console.log("lint: " + lint);	
	lint.forEach(highlight_error);
	document.getElementById('errors').innerHTML = JSON.stringify(lint, null, 2);
}
function lint_url(url){
	    const myUrl = url
        fetch(myUrl).then(function(r){
                r.text().then(function(oas){        
            		console.log("Updating editor.");
		            editor.getDoc().setValue(oas);
                	return lint_spec(oas); 
                });
        });
};

function highlight_error(entry){
	/*
{
    "code": "invalid-ref",
    "path": [
      "x-commons",
      "common-headers",
      "X-RateLimit-Limit",
      "$ref"
    ],
    "message": "No resolver defined for scheme 'https' in ref https://teamdigitale.github.io/openapi/0.0.5/definitions.yaml",
    "severity": 0,
    "range": {
      "start": {
        "line": 113,
        "character": 12
      },
      "end": {
        "line": 113,
        "character": 102
      }
    }
  },
 
	*/
	line = entry.range.start.line;
	ch = entry.range.start.character
	console.log("line:" + line);
	editor.addLineClass(line, 'background', 'line-error');
    document.getElementById('error-lines').innerHTML += 
        '<tr onClick="show_error('+ line +', ' + ch +')" text="'+ entry.message+ '"><td>'+line+'</td><td>'+ entry.code +'</td> <td>'+entry.message+'</td></tr>'
}

function show_error(line, ch) {
    editor.focus();
    editor.setCursor({line: line, ch: ch });
}


</script>

</head>
<body>
<h1>OpenAPI 3 Spec validator of compliance against Italian API Guidelines</h1>
Linting rules are in <a href="https://raw.githubusercontent.com/ioggstream/oas-spectral-validator/master/.spectral.yml%22">.spectral.yml</a>
<hr>
	<div id="form" class="editor-div">
	    Validate URL, the spec will be downloaded and shown in the editor below
        <br>
		<input type="text" name="url" id="oas_url" title="Write here the URL of an OAS spec." style="width: 30em;">
		<input type="button" onclick="parse_url();" value="validate url">
		<hr>
		You can download an OAS spec using the URL Validator above,
		then edit and validate the specification manually,
		or write/paste your API spec directly in the editor.

		Beware: downloading a specification will replace the editor content.
		<textarea id="oas_text"></textarea>
		<input type="button" onclick="parse_text();" value="validate text">
	</div>

	<div class="linter">
		This div will show linter errors.
		<table id="error-lines">
            <th><td>line</td><td>error</td><td>message</td></th>
		</table>
		<pre id="errors"></pre>
	</div>

<!--script src="https://cdn.jsdelivr.net/npm/bootstrap-italia@1.3.9/dist/js/bootstrap-italia.min.js"
     integrity="sha256-zNCAAQiaA5+QGlc7OUoSvdDqEZwhR+9kkUrnYwVKpQ8=" 
     crossorigin="anonymous"></script-->
</body>
<script>
var myTextarea = document.getElementById('oas_text');
var editor = CodeMirror.fromTextArea(myTextarea, {
    lineNumbers: true,
    styleSelected: true
});

</script>
</html>

