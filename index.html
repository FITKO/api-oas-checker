<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>Browserify hello world</title>
<link rel="stylesheet" href="./css/bootstrap-italia.min.css">

<style>
.line-error {
	background: #fbc2c4 !important;
}

.linter {
    float: right;
    width: 39%;
    background-color: yellow;
}

.editor-div {
	width: 60%;
	height: 100%;
	float: left;
}


</style>
<!-- load browserify_hello_world -->
<script src="out.js"></script>
<script>window.__PUBLIC_PATH__ = 'fonts'</script>

<!-- load codemirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.51.0/codemirror.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.51.0/codemirror.min.css">

<script>
testUrl = "https://raw.githubusercontent.com/teamdigitale/anpr-dashboard-server/master/openapi/anpr-dashboard.yaml";

function parse_url(){
	url = document.getElementById('oas_url').value;
    if (url == "") {
    	url = testUrl
    	document.getElementById('oas_url').value = testUrl
    }
    lint_url(url);
}

async function parse_text(){
	oas_text = editor.getValue();
    // console.log("oas_text:" + oas_text);
    document.getElementById('error-lines').innerHTML = '            <tr> <th>severity</th> <th>line</th> <th>error</th> <th>message</th> </tr>';
    await lint_spec(oas_text);
}

async function lint_spec(oas) {
	const lint = await browserify_hello_world.parse(oas);
	console.log("lint: " + lint);	
	lint.forEach(highlight_error);
	/// DEBUG document.getElementById('errors').innerHTML = JSON.stringify(lint, null, 2);
}
function lint_url(url){
	    const myUrl = url
        fetch(myUrl).then(function(r){
                r.text().then(function(oas){        
            		console.log("Updating editor.");
		            editor.getDoc().setValue(oas);
                	return lint_spec(oas); 
                });
        });
};

function highlight_error(entry){
	/*
{
    "code": "invalid-ref",
    "path": [
      "x-commons",
      "common-headers",
      "X-RateLimit-Limit",
      "$ref"
    ],
    "message": "No resolver defined for scheme 'https' in ref https://teamdigitale.github.io/openapi/0.0.5/definitions.yaml",
    "severity": 0,
    "range": {
      "start": {
        "line": 113,
        "character": 12
      },
      "end": {
        "line": 113,
        "character": 102
      }
    }
  },
 
	*/
	line = entry.range.start.line;
	ch = entry.range.start.character
	console.log("line:" + line);
	editor.addLineClass(line, 'background', 'line-error');
    document.getElementById('error-lines').innerHTML += 
        '<tr onClick="show_error('+ line +', ' + ch +')" text="'+ entry.message+ '">'
        +'<td>'+ entry.severity
        +'<td>'+line
        +'<td>'+ entry.code
        +'<td>'+entry.message+''
}

/**
 * Focus CodeMirror on the errored line.
 */
function show_error(line, ch) {
    editor.focus();
    editor.setCursor({line: line, ch: ch });
}


</script>

</head>
<body>


<header class="navbar-main navbar navbar-dark bd-navbar px-3 bd-navbar--slim">
	<div class="container-fluid">
		<div class="d-flex flex-column pl-3 pl-sm-4">
		<h1 class="bd-logo-title" style="color: white">OpenAPI 3 Spec linter</h1>
		<h4 class="bd-logo-subtitle" style="color: white">
			Checking compliance with Italian API Guidelines.

		</h4>
		</div>
	</div>
</header>

This standalone page uses <a href="https://github.com/stoplightio/spectral">Spectral</a> to lint
an OAS3 specification using the rules defined in
<a class="navbar-brand py-2 text-decoration-none" href="https://raw.githubusercontent.com/ioggstream/oas-spectral-validator/master/.spectral.yml%22">.spectral.yml</a>
<br>
		You can download an OAS spec using the URL linter and
		then edit and lint the specification manually,
		or write/paste your API spec directly in the editor.
        <br>
		<b>Beware: downloading an URL will replace the content of the editor.</b>
		<br>

<div class="container-fluid form-group" style="margin-top: 2em">
	<input type="text" name="url" id="oas_url" data-toggle="tooltip" title="Write here the URL of an OAS spec." style="width: 79%" >
	<input type="button" class="btn btn-primary" onclick="parse_url();" value="Lint URL" style="width: 20%">
    <label for="oas_url">Write here the URL of the OAS specification.</label>
</div>
<hr>

	<div id="form" class="editor-div">
		<h4 class="bd-logo-subtitle">
OpenAPI editor 		<input type="button" class="btn btn-primary" onclick="parse_text();" value="Lint text">
		</h4>
		<div class="form-group">
			<textarea id="oas_text" onchange='parse_text();'></textarea>
			<label for="oas_text">
				Write or modify here the OAS specification.
			</label>
		</div>
	</div>

	<div class="linter">
				<h4 class="bd-logo-subtitle" >
			Linting errors and warnings.
		</h4>
		<table id="error-lines">
            <tr>
				<th>severity</th>
				<th>line</th>
				<th>error</th>
				<th>message</th>
			</tr>
		</table>
		<pre id="errors"></pre>
	</div>

    <script src="./js/bootstrap-italia.bundle.min.js"></script>

</body>
<script>
var myTextarea = document.getElementById('oas_text');
myTextarea.addEventListener('input', (event) => {parse_text();});
var editor = CodeMirror.fromTextArea(myTextarea, {
    lineNumbers: true,
    styleSelected: true
});

</script>
</html>
