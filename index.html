<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>OpenAPI Linter for the Italian Interoperability Framework</title>
<link rel="stylesheet" href="./css/bootstrap-italia.min.css">
<!-- load browserify_hello_world -->
<script src="out.js"></script>
<script>window.__PUBLIC_PATH__ = 'fonts'</script>

<!-- load codemirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.51.0/codemirror.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.51.0/codemirror.min.css">
<link rel="stylesheet" href="https://codemirror.net/theme/darcula.css">
<style>
.line-error {
	background: blue !important;
}

.linter {
    float: right;
    width: 39%;
}

.editor-div {
	width: 60%;
	height: 100%;
	float: left;
}

.CodeMirror {
  border: 1px solid #eee;
  height: auto;
}

</style>

<script>
testUrl = "https://raw.githubusercontent.com/teamdigitale/anpr-dashboard-server/master/openapi/anpr-dashboard.yaml";

function parse_url(){
	url = document.getElementById('oas_url').value;
    if (url == "") {
    	url = testUrl
    	document.getElementById('oas_url').value = testUrl
    }
    lint_url(url);
}

async function parse_text(){
	// unmark old errored lines
	console.log("Unmark old errored lines.")
	marked_lines = document.getElementsByClassName('line-error')
	Array.prototype.forEach.call(marked_lines, (x)=>{x.classList.remove("line-error")})

	oas_text = editor.getValue();
    // console.log("oas_text:" + oas_text);
	error_header = '<div class="row"> '
		+'<div class="col-sm-1">severity</div>'
		 +'<div class="col-sm-1">line</div>'
		 +' <div class="col-sm-3">error</div> '
		 +'<div class="col-sm-5">message</div> </div>'
    document.getElementById('error-lines').innerHTML = error_header;
    await lint_spec(oas_text);
}

async function lint_spec(oas) {
	const lint = await browserify_hello_world.parse(oas);
	console.log("lint: " + lint);

	// mark errored lines
	lint.forEach(highlight_error);
	/// DEBUG document.getElementById('errors').innerHTML = JSON.stringify(lint, null, 2);
}
function lint_url(url){
	    const myUrl = url
        fetch(myUrl).then(function(r){
                r.text().then(function(oas){        
            		console.log("Updating editor.");
		            editor.getDoc().setValue(oas);
                	return lint_spec(oas); 
                });
        });
};

function highlight_error(entry){
	line = entry.range.start.line;
	ch = entry.range.start.character
	console.log("line:" + line);
	editor.addLineClass(line, 'background', 'line-error');
	error_line  =  `<div class="row" onClick="show_error(${line},${ch});">`
		+`<div class="col-sm-1">${entry.severity}</div>`
		+`<div class="col-sm-1">${line}</div>`
		+`<div class="col-sm-3">${entry.code}</div>`
		+`<div class="col-sm-5">${entry.message}</div>`
		+`</div>`;

    document.getElementById('error-lines').innerHTML += error_line;
}

/**
 * Focus CodeMirror on the errored line.
 */
function show_error(line, ch) {
    editor.focus();
    editor.setCursor({line: line, ch: ch });
}


</script>

</head>
<body>
<!--
 This page does not use a div class="container" as
 the expected layout is to use 100% width of the scree
 like eg. swagger editor.
-->
<header class="navbar-main navbar navbar-dark bd-navbar px-3 bd-navbar--slim">
	<div class="container-fluid">
		<div class="d-flex flex-column pl-3 pl-sm-4">
		<h1 class="bd-logo-title" style="color: white">OpenAPI 3 Spec linter</h1>
		<h4 class="bd-logo-subtitle" style="color: white">
			Checking compliance with Italian API Guidelines.

		</h4>
		</div>
	</div>
</header>

This standalone page uses <a href="https://github.com/stoplightio/spectral">Spectral</a> to lint
an OAS3 specification using the rules defined in
<a class="navbar-brand py-2 text-decoration-none" href="https://raw.githubusercontent.com/ioggstream/oas-spectral-validator/master/.spectral.yml%22">.spectral.yml</a>
<br>
You can download an OAS spec using the URL linter and
then edit and lint the specification manually,
or write/paste your API spec directly in the editor.
<br>
<b>Beware: downloading an URL will replace the content of the editor.</b>
<br>

<div class="container-fluid form-group" style="margin-top: 2em">
	<input type="text" name="url" id="oas_url" data-toggle="tooltip" title="Write here the URL of an OAS spec." style="width: 79%" >
	<input type="button" class="btn btn-primary" onclick="parse_url();" value="Lint URL" style="width: 20%">
    <label for="oas_url">Write here the URL of the OAS specification.</label>
</div>
<hr>

<div id="form" class="editor-div">
	<h4 class="bd-logo-subtitle">
		OpenAPI editor
		<input type="button" class="btn btn-primary" onclick="parse_text();" value="Lint text">
	</h4>
	<div class="form-group">
		<textarea id="oas_text"></textarea>
		<label for="oas_text">Write or modify here the OAS specification.</label>
	</div>
</div>

<!-- All errors are displayed here -->
<div class="linter">
	<h4 class="bd-logo-subtitle" >
		Linting errors and warnings.
	</h4>
	<div class="container" id="error-lines">
	  <div class="row">
		<div class="col-sm-1">severity</div>
		<div class="col-sm-1">line</div>
		<div class="col-sm-3">error</div>
		<div class="col-sm-5">message</div>
	  </div>
	</div>
</div>
<script src="./js/bootstrap-italia.bundle.min.js"></script>

</body>
<script>
var myTextarea = document.getElementById('oas_text');
var editor = CodeMirror.fromTextArea(myTextarea, {
    lineNumbers: true,
    styleSelected: true,
    mode: "text/x-yaml",
    theme: "darcula"
});
var counter =  Date.now();
function selectively_parse(){
	if ((Date.now() - counter) < 10000) {
		console.log("too early");
		return;
	}
	counter = Date.now();
	parse_text();
}
editor.on('change', (event) => {selectively_parse();});
</script>
</html>
